<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{shipper/layout}">
<head>
<title>Chi tiết giao hàng</title>
<link rel="stylesheet" href="/css/shipper/delivery-detail.css">
</head>
<body>
	<h1 layout:fragment="page-title">Chi tiết đơn giao</h1>

	<div layout:fragment="content">

		<!-- Flash -->
		<div th:if="${success}" class="alert alert-success"
			th:text="${success}"></div>
		<div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

		<!-- Back -->
		<div class="mb-3">
			<a th:href="@{/shipper/deliveries}" class="btn btn-outline-secondary">
				<i class="fas fa-arrow-left me-1"></i> Quay lại danh sách
			</a>
		</div>

		<!-- Order summary -->
		<div class="admin-table mb-4">
			<div class="table-header">
				<h5 class="mb-0">
					<i class="fas fa-receipt me-2"></i>Thông tin đơn
				</h5>
			</div>
			<div class="p-3 row g-3">
				<div class="col-md-6">
					<p class="mb-1">
						<strong>Mã đơn:</strong> <span
							th:text="${order != null ? order.orderID : ''}">ORD</span>
					</p>
					<p class="mb-1">
						<strong>Trạng thái:</strong> <span class="badge"
							th:text="${order != null ? T(com.womtech.util.OrderStatusHelper).getStatusLabel(order.status) : ''}"
							th:classappend="' ' + ${T(com.womtech.util.OrderStatusHelper).getStatusBadgeClass(order.status)}">--</span>
					</p>
					<p class="mb-1">
						<strong>Ngày tạo:</strong> <span
							th:if="${order != null and order.createAt != null}"
							th:text="${#temporals.format(order.createAt,'dd/MM/yyyy HH:mm')}">--</span>
						<span th:if="${order == null or order.createAt == null}">--</span>
					</p>
				</div>
				<div class="col-md-6">
					<p class="mb-1">
						<strong>Thanh toán:</strong> <span
							th:text="${order != null ? order.paymentMethod : ''}">--</span>
					</p>
					<p class="mb-1">
						<strong>Trạng thái thanh toán:</strong> <span class="badge"
							th:text="${T(com.womtech.util.OrderStatusHelper).getPaymentStatusLabel(order.paymentStatus)}"
							th:classappend="' ' + ${T(com.womtech.util.OrderStatusHelper).getPaymentBadgeClass(order.paymentStatus)}">--</span>
					</p>
					<p class="mb-1">
						<strong>Tổng tiền:</strong> <span
							th:text="${order != null && order.totalPrice != null ? #numbers.formatDecimal(order.totalPrice,0,'COMMA',0,'POINT') + ' ₫' : '0 ₫'}">0
							₫</span>
					</p>
				</div>
			</div>
		</div>

		<!-- Customer & address -->
		<div class="row g-4 mb-4">
			<div class="col-md-6">
				<div class="admin-table">
					<div class="table-header">
						<h5 class="mb-0">
							<i class="fas fa-user me-2"></i>Khách hàng
						</h5>
					</div>
					<div class="p-3">
						<p class="mb-1">
							<strong>Tài khoản:</strong> <span
								th:text="${order != null && order.user != null ? order.user.username : ''}">--</span>
						</p>
						<p class="mb-1">
							<strong>Email:</strong> <span
								th:text="${order != null && order.user != null ? order.user.email : ''}">--</span>
						</p>
						<p class="mb-1">
							<strong>Điện thoại:</strong> <span
								th:text="${order != null && order.address != null ? order.address.phone : ''}">--</span>
						</p>
					</div>
				</div>
			</div>

			<div class="col-md-6">
				<div class="admin-table">
					<div class="table-header">
						<h5 class="mb-0">
							<i class="fas fa-map-marker-alt me-2"></i>Địa chỉ giao
						</h5>
					</div>
					<div class="p-3">
						<div th:if="${order != null && order.address != null}">
							<div th:text="${order.address.fullname}">Tên người nhận</div>
							<div class="text-muted small"
								th:text="${order.address.street + ', ' + order.address.ward + ', ' + order.address.district + ', ' + order.address.city}">
								Địa chỉ</div>
						</div>
						<div th:if="${order == null || order.address == null}"
							class="text-muted">--</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Items -->
		<div class="admin-table mb-4">
			<div class="table-header">
				<h5 class="mb-0">
					<i class="fas fa-box me-2"></i>Sản phẩm
				</h5>
			</div>
			<div class="table-responsive">
				<table class="table mb-0">
					<thead>
						<tr>
							<th>Sản phẩm</th>
							<th>Đơn giá</th>
							<th>Số lượng</th>
							<th>Thành tiền</th>
							<th>Trạng thái</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="it : ${order.items}">
							<td th:text="${it.product != null ? it.product.name : '---'}">Tên
								SP</td>
							<td
								th:text="${#numbers.formatDecimal(it.price,0,'COMMA',0,'POINT')} + ' ₫'">0
								₫</td>
							<td th:text="${it.quantity}">1</td>

							<!-- KHÔNG nhân trong template, ưu tiên itemTotal -->
							<td
								th:text="${it.itemTotal != null
                                   ? #numbers.formatDecimal(it.itemTotal,0,'COMMA',0,'POINT') + ' ₫'
                                   : (#numbers.formatDecimal(it.price,0,'COMMA',0,'POINT') + ' ₫')}">0
								₫</td>

							<td><span class="badge"
								th:text="${T(com.womtech.util.OrderStatusHelper).getItemStatusLabel(it.status)}"
								th:classappend="' ' + ${T(com.womtech.util.OrderStatusHelper).getItemStatusBadgeClass(it.status)}">--</span>
							</td>
						</tr>
						<tr
							th:if="${order == null || order.items == null || #lists.isEmpty(order.items)}">
							<td colspan="5" class="text-center text-muted py-4">Không có
								sản phẩm.</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!-- Actions for shipper -->
		<div class="admin-table">
			<div class="table-header">
				<h5 class="mb-0">
					<i class="fas fa-gear me-2"></i>Thao tác
				</h5>
			</div>
			<div class="p-3 d-flex gap-2 flex-wrap">

				<!-- HUỶ ĐƠN (khi chưa kết thúc) -->
				<form
					th:action="@{'/shipper/deliveries/' + ${order.orderID} + '/transition'}"
					method="post"
					th:if="${order != null
                          and order.status != T(com.womtech.util.OrderStatusHelper).STATUS_DELIVERED
                          and order.status != T(com.womtech.util.OrderStatusHelper).STATUS_RETURNED
                          and order.status != T(com.womtech.util.OrderStatusHelper).STATUS_CANCELLED}">
					<input type="hidden" name="targetStatus"
						th:value="${T(com.womtech.util.OrderStatusHelper).STATUS_CANCELLED}">
					<button class="btn btn-outline-danger"
						onclick="return confirm('Xác nhận huỷ đơn này?');">
						<i class="fas fa-times-circle me-1"></i> Huỷ đơn
					</button>
				</form>

				<!-- ĐANG GIAO (khi >= PACKED và < SHIPPED) -->
				<form
					th:action="@{'/shipper/deliveries/' + ${order.orderID} + '/transition'}"
					method="post"
					th:if="${order != null
                          and order.status != null
                          and order.status < T(com.womtech.util.OrderStatusHelper).STATUS_SHIPPED
                          and order.status >= T(com.womtech.util.OrderStatusHelper).STATUS_PACKED}">
					<input type="hidden" name="targetStatus"
						th:value="${T(com.womtech.util.OrderStatusHelper).STATUS_SHIPPED}">
					<button class="btn btn-warning">
						<i class="fas fa-truck-fast me-1"></i> Đánh dấu Đang giao
					</button>
				</form>

				<!-- GIAO THÀNH CÔNG (khi đang SHIPPED) -->
				<form
					th:action="@{'/shipper/deliveries/' + ${order.orderID} + '/transition'}"
					method="post"
					th:if="${order != null
                          and order.status == T(com.womtech.util.OrderStatusHelper).STATUS_SHIPPED}">
					<input type="hidden" name="targetStatus"
						th:value="${T(com.womtech.util.OrderStatusHelper).STATUS_DELIVERED}">
					<button class="btn btn-success">
						<i class="fas fa-circle-check me-1"></i> Giao thành công
					</button>
				</form>

				<!-- HOÀN TRẢ (khi đang SHIPPED) -->
				<form
					th:action="@{'/shipper/deliveries/' + ${order.orderID} + '/transition'}"
					method="post"
					th:if="${order != null
                          and order.status == T(com.womtech.util.OrderStatusHelper).STATUS_SHIPPED}">
					<input type="hidden" name="targetStatus"
						th:value="${T(com.womtech.util.OrderStatusHelper).STATUS_RETURNED}">
					<button class="btn btn-outline-secondary">
						<i class="fas fa-undo me-1"></i> Hoàn trả
					</button>
				</form>

				<!-- XÁC NHẬN THU COD (khi đã giao & chưa thu) -->
				<form
					th:action="@{'/shipper/deliveries/' + ${order.orderID} + '/confirm-cod'}"
					method="post"
					th:if="${order != null
                          and order.paymentMethod != null
                          and #strings.contains(order.paymentMethod.toUpperCase(),'COD')
                          and order.status == T(com.womtech.util.OrderStatusHelper).STATUS_DELIVERED
                          and (order.paymentStatus == null or order.paymentStatus == 0)}">
					<button class="btn btn-primary">
						<i class="fas fa-sack-dollar me-1"></i> Xác nhận đã thu COD
					</button>
				</form>

			</div>
		</div>

	</div>
</body>
</html>