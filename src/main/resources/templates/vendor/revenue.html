<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{vendor/layout}">
<head>
<title>Báo Cáo Doanh Thu - Vendor Panel</title>
<!-- Link to external CSS -->
<link rel="stylesheet" th:href="@{/css/vendor/revenue.css}">
</head>
<body>
	<h1 layout:fragment="page-title">Báo Cáo Doanh Thu</h1>

	<div layout:fragment="content">
		<!-- Period Selection -->
		<div class="admin-table mb-4">
			<div class="table-header">
				<h5 class="mb-0">
					<i class="fas fa-calendar me-2"></i> Chọn Khoảng Thời Gian
				</h5>
			</div>
			<div class="p-4">
				<div class="row g-3 align-items-end">
					<div class="col-md-10">
						<div class="btn-group mb-3" role="group">
							<a th:href="@{/vendor/revenue(period='today')}" class="btn"
								th:classappend="${period == 'today' ? 'btn-primary' : 'btn-outline-primary'}">
								Hôm Nay </a> <a th:href="@{/vendor/revenue(period='week')}"
								class="btn"
								th:classappend="${period == 'week' ? 'btn-primary' : 'btn-outline-primary'}">
								7 Ngày Qua </a> <a th:href="@{/vendor/revenue(period='month')}"
								class="btn"
								th:classappend="${period == 'month' ? 'btn-primary' : 'btn-outline-primary'}">
								30 Ngày Qua </a> <a th:href="@{/vendor/revenue(period='year')}"
								class="btn"
								th:classappend="${period == 'year' ? 'btn-primary' : 'btn-outline-primary'}">
								1 Năm Qua </a>
						</div>

						<form method="get" th:action="@{/vendor/revenue}">
							<input type="hidden" name="period" value="custom">
							<div class="row g-2">
								<div class="col-md-5">
									<label class="form-label">Từ Ngày</label> <input type="date"
										class="form-control" name="startDate" th:value="${startDate}"
										required>
								</div>
								<div class="col-md-5">
									<label class="form-label">Đến Ngày</label> <input type="date"
										class="form-control" name="endDate" th:value="${endDate}"
										required>
								</div>
								<div class="col-md-2">
									<label class="form-label">&nbsp;</label>
									<button type="submit" class="btn btn-primary w-100">
										<i class="fas fa-search"></i>
									</button>
								</div>
							</div>
						</form>
					</div>
					<div class="col-md-2">
						<a href="/vendor/revenue" class="btn btn-outline-secondary w-100">
							<i class="fas fa-redo me-2"></i>Đặt Lại
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Statistics Summary -->
		<div class="row g-4 mb-4">
			<div class="col-md-3">
				<div class="stat-card">
					<div class="stat-icon"
						style="background: linear-gradient(135deg, #10b981, #34d399); color: white;">
						<i class="fas fa-money-bill-wave"></i>
					</div>
					<div class="stat-value"
						th:text="${#numbers.formatDecimal(statistics.totalRevenue, 0, 'COMMA', 0, 'POINT')}">0</div>
					<div class="stat-label">Tổng Doanh Thu (₫)</div>
				</div>
			</div>

			<div class="col-md-3">
				<div class="stat-card">
					<div class="stat-icon"
						style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white;">
						<i class="fas fa-shopping-cart"></i>
					</div>
					<div class="stat-value" th:text="${statistics.totalOrders}">0</div>
					<div class="stat-label">Tổng Đơn Hàng</div>
				</div>
			</div>

			<div class="col-md-3">
				<div class="stat-card">
					<div class="stat-icon"
						style="background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white;">
						<i class="fas fa-chart-line"></i>
					</div>
					<div class="stat-value"
						th:text="${statistics.totalOrders > 0 ? #numbers.formatDecimal(statistics.totalRevenue / statistics.totalOrders, 0, 'COMMA', 0, 'POINT') : 0}">0</div>
					<div class="stat-label">Giá Trị TB/Đơn (₫)</div>
				</div>
			</div>

			<div class="col-md-3">
				<div class="stat-card">
					<div class="stat-icon"
						style="background: linear-gradient(135deg, #7c3aed, #a78bfa); color: white;">
						<i class="fas fa-percentage"></i>
					</div>
					<div class="stat-value"
						th:text="${statistics.deliveredOrders}">0</div>
					<div class="stat-label">Đơn Hoàn Thành</div>
				</div>
			</div>
		</div>

		<!-- Charts Section with Tabs -->
		<div class="admin-table mb-4">
			<div class="table-header">
				<h5 class="mb-0">
					<i class="fas fa-chart-bar me-2"></i> Phân Tích Dữ Liệu
				</h5>
			</div>
			
			<!-- Chart Tabs -->
			<ul class="nav nav-tabs chart-tabs px-4 pt-3" id="chartTabs" role="tablist">
				<li class="nav-item" role="presentation">
					<button class="nav-link active" id="revenue-tab" data-bs-toggle="tab" 
						data-bs-target="#revenue-chart" type="button" role="tab">
						<i class="fas fa-chart-line me-2"></i>Doanh Thu Theo Thời Gian
					</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="category-tab" data-bs-toggle="tab" 
						data-bs-target="#category-chart" type="button" role="tab">
						<i class="fas fa-chart-pie me-2"></i>Phân Loại Sản Phẩm
					</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="products-tab" data-bs-toggle="tab" 
						data-bs-target="#products-chart" type="button" role="tab">
						<i class="fas fa-chart-bar me-2"></i>Top Sản Phẩm Bán Chạy
					</button>
				</li>
			</ul>
			
			<!-- Chart Contents -->
			<div class="tab-content chart-tab-content" id="chartTabContent">
				<!-- Revenue Chart Tab -->
				<div class="tab-pane fade show active" id="revenue-chart" role="tabpanel">
					<div class="chart-container">
						<canvas id="revenueChart"></canvas>
					</div>
					<div class="mt-3 text-muted small">
						<i class="fas fa-info-circle me-1"></i>
						Biểu đồ thể hiện doanh thu hàng ngày trong khoảng thời gian đã chọn
					</div>
				</div>
				
				<!-- Category Chart Tab -->
				<div class="tab-pane fade" id="category-chart" role="tabpanel">
					<div class="row">
						<div class="col-md-8">
							<div class="chart-container">
								<canvas id="categoryChart"></canvas>
							</div>
						</div>
						<div class="col-md-4">
							<h6 class="mb-3">Chi Tiết Doanh Thu Theo Danh Mục</h6>
							<div class="category-list">
								<div th:each="category, iter : ${categoryLabels}" class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
									<div class="d-flex align-items-center">
										<span class="category-color" 
											th:classappend="'cat-color-' + ${iter.index % 10}"></span>
										<span th:text="${category}">Category</span>
									</div>
									<strong th:text="${#numbers.formatDecimal(categoryValues[iter.index], 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</strong>
								</div>
								<div th:if="${#lists.isEmpty(categoryLabels)}" class="text-center text-muted py-4">
									<i class="fas fa-chart-pie fa-2x mb-2"></i>
									<p>Không có dữ liệu danh mục</p>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<!-- Top Products Chart Tab -->
				<div class="tab-pane fade" id="products-chart" role="tabpanel">
					<div class="row">
						<div class="col-md-8">
							<div class="chart-container">
								<canvas id="topProductsChart"></canvas>
							</div>
						</div>
						<div class="col-md-4">
							<h6 class="mb-3">Top Sản Phẩm Bán Chạy</h6>
							<div class="products-list">
								<div th:each="product, iter : ${topProductLabels}" class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
									<div class="product-info">
										<div class="fw-medium" th:text="${product}">Product</div>
										<small class="text-muted" th:text="'Thứ hạng: ' + (iter.index + 1)">Rank</small>
									</div>
									<div class="text-end">
										<strong th:text="${topProductValues[iter.index]}">0</strong>
										<div class="text-muted small">đã bán</div>
									</div>
								</div>
								<div th:if="${#lists.isEmpty(topProductLabels)}" class="text-center text-muted py-4">
									<i class="fas fa-boxes fa-2x mb-2"></i>
									<p>Không có dữ liệu sản phẩm</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Period Info -->
		<div class="admin-table">
			<div class="table-header">
				<h5 class="mb-0">
					<i class="fas fa-info-circle me-2"></i> Thông Tin Khoảng Thời Gian
				</h5>
			</div>
			<div class="p-4">
				<div class="row">
					<div class="col-md-6">
						<p class="mb-2">
							<strong>Từ Ngày:</strong> <span
								th:text="${#temporals.format(statistics.startDate, 'dd/MM/yyyy HH:mm')}">Date</span>
						</p>
					</div>
					<div class="col-md-6">
						<p class="mb-2">
							<strong>Đến Ngày:</strong> <span
								th:text="${#temporals.format(statistics.endDate, 'dd/MM/yyyy HH:mm')}">Date</span>
						</p>
					</div>
				</div>

				<hr>

				<div class="alert alert-info mb-0">
					<i class="fas fa-info-circle me-2"></i> <strong>Lưu ý:</strong>
					Doanh thu được tính dựa trên tổng giá trị các sản phẩm của bạn
					trong các đơn hàng trong khoảng thời gian đã chọn. Chỉ bao gồm các
					sản phẩm mà bạn là chủ sở hữu.
				</div>
			</div>
		</div>
		
		<!-- Chart.js library -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<!-- Bootstrap JS for tabs -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

		<!-- Revenue Charts Script -->
		<script th:inline="javascript">
/*<![CDATA[*/
    // Data from Thymeleaf
    const revenueLabels = /*[[${revenueDates}]]*/ [];
    const revenueValues = /*[[${revenueValues}]]*/ [];
    
    const categoryLabels = /*[[${categoryLabels}]]*/ [];
    const categoryValues = /*[[${categoryValues}]]*/ [];
    const categoryColors = /*[[${categoryColors}]]*/ [];
    
    const topProductLabels = /*[[${topProductLabels}]]*/ [];
    const topProductValues = /*[[${topProductValues}]]*/ [];
    const productColors = /*[[${productColors}]]*/ [];
    
    // Chart instances
    let revenueChartInstance = null;
    let categoryChartInstance = null;
    let topProductsChartInstance = null;

    // Initialize Charts when page loads
    document.addEventListener('DOMContentLoaded', function() {
        try {
            initializeRevenueChart();
            
            if (categoryLabels && categoryLabels.length > 0) {
                initializeCategoryChart();
            }
            
            if (topProductLabels && topProductLabels.length > 0) {
                initializeTopProductsChart();
            }
            
            setupTabListeners();
            
        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    });

    function setupTabListeners() {
        const revenueTab = document.getElementById('revenue-tab');
        const categoryTab = document.getElementById('category-tab');
        const productsTab = document.getElementById('products-tab');

        if (revenueTab) {
            revenueTab.addEventListener('shown.bs.tab', function() {
                if (revenueChartInstance) {
                    revenueChartInstance.resize();
                    revenueChartInstance.update();
                }
            });
        }

        if (categoryTab) {
            categoryTab.addEventListener('shown.bs.tab', function() {
                if (categoryChartInstance) {
                    categoryChartInstance.resize();
                    categoryChartInstance.update();
                }
            });
        }

        if (productsTab) {
            productsTab.addEventListener('shown.bs.tab', function() {
                if (topProductsChartInstance) {
                    topProductsChartInstance.resize();
                    topProductsChartInstance.update();
                }
            });
        }
    }

    function initializeRevenueChart() {
        const canvas = document.getElementById('revenueChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        revenueChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: revenueLabels,
                datasets: [{
                    label: 'Doanh thu (₫)',
                    data: revenueValues,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59,130,246,0.1)',
                    fill: true,
                    tension: 0.3,
                    borderWidth: 2,
                    pointBackgroundColor: '#2563eb',
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const value = ctx.parsed.y.toLocaleString('vi-VN');
                                return ' Doanh thu: ' + value + ' ₫';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Ngày' },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Doanh thu (₫)' },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('vi-VN') + ' ₫';
                            }
                        }
                    }
                },
                interaction: { intersect: false, mode: 'index' }
            }
        });
    }

    function initializeCategoryChart() {
        const canvas = document.getElementById('categoryChart');
        if (!canvas || !categoryColors || categoryColors.length === 0) return;

        const ctx = canvas.getContext('2d');
        categoryChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryValues,
                    backgroundColor: categoryColors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            boxWidth: 12
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((ctx.parsed / total) * 100).toFixed(1);
                                const value = ctx.formattedValue.toLocaleString('vi-VN');
                                return ` ${ctx.label}: ${value} ₫ (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '50%'
            }
        });
    }

    function initializeTopProductsChart() {
        const canvas = document.getElementById('topProductsChart');
        if (!canvas || !productColors || productColors.length === 0) return;

        const ctx = canvas.getContext('2d');
        topProductsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: topProductLabels,
                datasets: [{
                    label: 'Số lượng bán',
                    data: topProductValues,
                    backgroundColor: productColors[0],
                    borderColor: '#059669',
                    borderWidth: 1,
                    borderRadius: 4,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => ` Số lượng: ${ctx.formattedValue}`
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Số lượng bán' },
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    }

    // Cleanup when leaving page
    window.addEventListener('beforeunload', function() {
        if (revenueChartInstance) revenueChartInstance.destroy();
        if (categoryChartInstance) categoryChartInstance.destroy();
        if (topProductsChartInstance) topProductsChartInstance.destroy();
    });

/*]]>*/
</script>
	</div>
</body>
</html>