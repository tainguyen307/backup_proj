<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{vendor/layout}">
<head>
<title>Chi Tiết Đơn Hàng - Vendor Panel</title>
<link rel="stylesheet" href="/css/vendor/order-detail.css">
<style>
.item-status-form {
	display: flex;
	gap: 8px;
	align-items: flex-end;
}

.item-status-select {
	min-width: 180px;
}
</style>
</head>
<body>
	<h1 layout:fragment="page-title">Chi Tiết Đơn Hàng</h1>

	<div layout:fragment="content">

		<!-- Quay lại -->
		<div class="mb-4">
			<a href="/vendor/orders" class="btn btn-outline-secondary"> <i
				class="fas fa-arrow-left me-2"></i>Quay Lại Danh Sách
			</a>
		</div>

		<!-- Thông báo -->
		<div th:if="${success}" class="alert alert-success"
			th:text="${success}"></div>
		<div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

		<!-- Thông tin đơn hàng -->
		<div class="row g-4 mb-4">
			<div class="col-md-8">
				<div class="admin-table">
					<div class="table-header">
						<h5>
							<i class="fas fa-info-circle me-2"></i>Thông Tin Đơn Hàng
						</h5>
					</div>
					<div class="p-4">
						<div class="row g-3">
							<div class="col-md-6">
								<p>
									<strong>Mã đơn:</strong> <span th:text="${order.orderID}"></span>
								</p>
								<p>
									<strong>Trạng thái:</strong> <span class="badge"
										th:text="${OrderStatusHelper.getStatusLabel(order.status)}"
										th:classappend="' ' + ${OrderStatusHelper.getStatusBadgeClass(order.status)}"></span>
								</p>
								<p>
									<strong>Thanh toán:</strong> <span
										th:text="${order.paymentMethod}"></span>
								</p>
							</div>
							<div class="col-md-6">
								<p>
									<strong>Ngày đặt:</strong> <span
										th:text="${#temporals.format(order.createAt, 'dd/MM/yyyy HH:mm')}"></span>
								</p>
								<p>
									<strong>Trạng thái thanh toán:</strong> <span class="badge"
										th:text="${OrderStatusHelper.getPaymentStatusLabel(order.paymentStatus)}"
										th:classappend="' ' + ${OrderStatusHelper.getPaymentBadgeClass(order.paymentStatus)}"></span>
								</p>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Thông tin khách hàng -->
			<div class="col-md-4">
				<div class="admin-table p-3 border rounded shadow-sm">
					<div class="table-header mb-3 border-bottom pb-2">
						<h5 class="mb-0">
							<i class="fas fa-user me-2 text-primary"></i>Thông Tin Khách Hàng
						</h5>
					</div>

					<div class="mb-2">
						<p class="mb-1">
							<i class="fas fa-id-badge me-2 text-secondary"></i> <strong>Tài
								khoản:</strong> <span th:text="${order.user.username}">username</span>
						</p>
						<p class="mb-1">
							<i class="fas fa-envelope me-2 text-secondary"></i> <strong>Email:</strong>
							<span th:text="${order.user.email}">email@example.com</span>
						</p>
					</div>

					<hr>

					<div class="mt-2">
						<p class="mb-1">
							<i class="fas fa-user-tag me-2 text-secondary"></i> <strong>Tên
								người nhận:</strong> <span th:text="${order.address.fullname}">Nguyễn
								Văn A</span>
						</p>
						<p class="mb-1">
							<i class="fas fa-phone me-2 text-secondary"></i> <strong>Số
								điện thoại:</strong> <span th:text="${order.address.phone}">0123456789</span>
						</p>
						<p class="mb-1">
							<i class="fas fa-map-marker-alt me-2 text-secondary"></i> <strong>Địa
								chỉ:</strong> <span
								th:text="${order.address.street} + ', ' + ${order.address.ward} + ', ' + ${order.address.district} + ', ' + ${order.address.city}">
								123 Lê Lợi, Phường 1, Quận 3, TP.HCM </span>
						</p>
					</div>

					<!-- Nếu ĐÃ gán shipper -->
					<div class="mt-3" th:if="${order.shipper != null}">
						<div class="p-3 border rounded bg-light">
							<p class="mb-1">
								<i class="fas fa-truck me-2 text-success"></i> <strong>Shipper:</strong>
								<span th:text="${order.shipper.username}"></span> <span
									class="text-muted" th:if="${order.shipper.email != null}">
									(<span th:text="${order.shipper.email}"></span>)
								</span>
							</p>
							<p class="mb-0" th:if="${order.assignedAt != null}">
								<i class="far fa-clock me-2 text-secondary"></i> <strong>Gán
									lúc:</strong> <span
									th:text="${#temporals.format(order.assignedAt, 'dd/MM/yyyy HH:mm')}"></span>
							</p>
						</div>

						<!-- Nút huỷ gán -->
						<form class="mt-2 d-inline"
							th:action="@{'/vendor/orders/unassign-shipper/' + ${order.orderID}}"
							method="post">
							<button type="submit" class="btn btn-outline-danger btn-sm">
								<i class="fas fa-times-circle me-1"></i> Huỷ gán shipper
							</button>
						</form>
					</div>

					<!-- Nếu CHƯA gán shipper -->
					<div class="text-center mt-3" th:if="${order.shipper == null}">
						<button type="button" class="btn btn-outline-primary"
							data-bs-toggle="modal" data-bs-target="#assignShipperModal">
							<i class="fas fa-truck me-2"></i> Chọn shipper cho đơn hàng
						</button>
					</div>

				</div>
			</div>
		</div>

		<!-- Sản phẩm của vendor -->
		<div class="admin-table mb-4">
			<div class="table-header">
				<h5>
					<i class="fas fa-box me-2"></i>Sản Phẩm Của Bạn Trong Đơn Hàng
				</h5>
			</div>
			<div class="table-responsive">
				<table class="table mb-0">
					<thead>
						<tr>
							<th>Hình</th>
							<th>Sản phẩm</th>
							<th>Thương hiệu</th>
							<th>Đơn giá</th>
							<th>Số lượng</th>
							<th>Thành tiền</th>
							<th>Trạng thái</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="item : ${vendorItems}">
							<!-- Hình -->
							<td><img
								th:if="${item.product.thumbnail != null && !item.product.thumbnail.isEmpty()}"
								th:src="${item.product.thumbnail}" alt="item.product"
								class="rounded"
								style="width: 60px; height: 60px; object-fit: cover;">
								<div
									th:if="${item.product.thumbnail == null || item.product.thumbnail.isEmpty()}"
									class="bg-light rounded d-flex align-items-center justify-content-center"
									style="width: 60px; height: 60px;">
									<i class="fas fa-image fa-2x text-muted"></i>
								</div></td>

							<!-- Tên sản phẩm -->
							<td><strong th:text="${item.product.name}">item.product
									Name</strong></td>

							<!-- Thương hiệu -->
							<td><span class="badge bg-secondary"
								th:text="${item.product.brand.name}">Brand</span></td>

							<!-- Đơn giá -->
							<td
								th:text="${#numbers.formatDecimal(item.price,0,'COMMA',0,'POINT')} + ' ₫'"></td>

							<!-- Số lượng -->
							<td th:text="${item.quantity}"></td>

							<!-- Thành tiền (gộp chiết khấu) -->
							<td>
								<div class="d-flex align-items-center gap-2">
									<del th:if="${item.netTotal != item.price}"
										class="text-muted small me-2"
										th:text="${#numbers.formatDecimal(item.price.multiply(item.quantity),0,'COMMA',0,'POINT')} + ' ₫'">
									</del>

									<strong class="text-success"
										th:text="${#numbers.formatDecimal(item.netTotal.multiply(item.quantity),0,'COMMA',0,'POINT')} + ' ₫'"
										data-bs-toggle="tooltip" data-bs-placement="top"
										title="Thành tiền sau chiết khấu của sàn"> </strong> <span
										th:if="${item.netTotal != item.price and item.price > 0}"
										class="badge bg-success ms-2" data-bs-toggle="tooltip"
										title="Phần trăm chiết khấu được áp dụng"> <span
										th:text="${#numbers.formatDecimal((1 - item.netTotal / item.price) * 100, 1, 'COMMA', 0, 'POINT')} + ' %'"></span>
									</span>
								</div>
							</td>

							<!-- Trạng thái (badge + 1 form cập nhật) -->
							<td>
								<div class="mb-2">
									<span class="badge"
										th:text="${OrderStatusHelper.getItemStatusLabel(item.status)}"
										th:classappend="' ' + ${OrderStatusHelper.getItemStatusBadgeClass(item.status)}"></span>
								</div>

								<form
									th:action="@{'/vendor/orders/update-item-status/' + ${order.orderID} + '/' + ${item.orderItemID}}"
									method="post" class="item-status-form">
									<input type="hidden" name="vendorId"
										th:value="${currentUser.userID}" /> <select name="newStatus"
										class="form-select form-select-sm item-status-select" required>
										<option value="">-- Chọn trạng thái --</option>
										<option th:value="${OrderStatusHelper.ITEM_STATUS_CANCELLED}"
											th:text="'Hủy'"
											th:disabled="${item.status == OrderStatusHelper.ITEM_STATUS_CANCELLED}"></option>
										<option th:value="${OrderStatusHelper.ITEM_STATUS_CONFIRMED}"
											th:text="'Xác Nhận'"
											th:disabled="${item.status >= OrderStatusHelper.ITEM_STATUS_CONFIRMED}"></option>
										<option th:value="${OrderStatusHelper.ITEM_STATUS_PREPARING}"
											th:text="'Chuẩn Bị'"
											th:disabled="${item.status >= OrderStatusHelper.ITEM_STATUS_PREPARING}"></option>
										<option th:value="${OrderStatusHelper.ITEM_STATUS_PACKED}"
											th:text="'Đóng Gói'"
											th:disabled="${item.status >= OrderStatusHelper.ITEM_STATUS_PACKED}"></option>
										<option th:value="${OrderStatusHelper.ITEM_STATUS_SHIPPED}"
											th:text="'Đang Giao'"
											th:disabled="${item.status >= OrderStatusHelper.ITEM_STATUS_SHIPPED}"></option>
										<option th:value="${OrderStatusHelper.ITEM_STATUS_DELIVERED}"
											th:text="'Đã Giao'"
											th:disabled="${item.status >= OrderStatusHelper.ITEM_STATUS_DELIVERED}"></option>
									</select>

									<button type="submit" class="btn btn-sm btn-primary">
										<i class="fas fa-save"></i>
									</button>
								</form>
							</td>
						</tr>
					</tbody>

					<tfoot>
						<tr>
							<td colspan="6" class="text-end"><strong>Tổng tiền
									của bạn:</strong></td>
							<td
								th:text="${#numbers.formatDecimal(vendorSubtotal,0,'COMMA',0,'POINT')} + ' ₫'"></td>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>

		<!-- MODAL: Danh sách Shipper -->
		<div class="modal fade" id="assignShipperModal" tabindex="-1"
			aria-labelledby="assignShipperModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content border-0 shadow-lg">
					<div class="modal-header bg-primary text-white">
						<h5 class="modal-title" id="assignShipperModalLabel">
							<i class="fas fa-truck me-2"></i>Chọn Shipper Giao Hàng
						</h5>
						<button type="button" class="btn-close btn-close-white"
							data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form
							th:action="@{'/vendor/orders/assign-shipper/' + ${order.orderID}}"
							method="post" id="assignShipperForm">

							<div class="mb-3">
								<label for="shipperSelect" class="form-label fw-semibold">Chọn
									Shipper:</label> <select class="form-select" id="shipperSelect"
									name="shipperID" required>
									<option value="" disabled selected>-- Chọn shipper --</option>
									<option th:each="s : ${shippers}" th:value="${s.userID}"
										th:text="${s.username + ' (' + s.email + ')'}"></option>
								</select>
							</div>

							<div class="mb-3">
								<label for="note" class="form-label fw-semibold">Ghi chú
									cho shipper (nếu có):</label>
								<textarea class="form-control" id="note" name="note" rows="2"
									placeholder="Ví dụ: Giao giờ hành chính, gọi trước khi giao..."></textarea>
							</div>

							<div class="text-end">
								<button type="button" class="btn btn-secondary me-2"
									data-bs-dismiss="modal">Hủy</button>
								<button type="submit" class="btn btn-primary">
									<i class="fas fa-check me-1"></i> Xác nhận chọn shipper
								</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

	</div>
</body>
</html>
