<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.name} + ' - WOMTech'">Product Detail</title>
    <link rel="stylesheet" th:href="@{/css/user/product-detail.css}">
    <script th:src="@{/js/user/favorite-detail.js}"></script>
    <script th:src="@{/js/user/chat.js}"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body>
	<div layout:fragment="content" class="container py-5">
		<!-- Thông báo thêm giỏ hàng -->
		<div th:if="${param.added}"
			class="alert alert-success alert-dismissible fade show text-center"
			role="alert">
			<i class="fas fa-check-circle me-2"></i> Sản phẩm đã được thêm vào
			giỏ hàng!
			<button type="button" class="btn-close" data-bs-dismiss="alert"
				aria-label="Close"></button>
		</div>
		
		<!-- Breadcrumb -->
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb bg-light p-2 rounded">
				<li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
				<li class="breadcrumb-item"><a
					th:href="@{/products(subcategory=${product.subcategory.subcategoryID})}"
					th:text="${product.subcategory.name}">Subcategory</a></li>
				<li class="breadcrumb-item active" aria-current="page"
					th:text="${product.name}">Product</li>
			</ol>
		</nav>

		<div class="row g-5">
			<!-- IMAGE GALLERY -->
			<div class="col-lg-6">
				<img th:src="${product.thumbnail}"
					th:alt="${product.name}" class="img-fluid main-image mb-3"
					id="mainImage">
				<div class="d-flex gap-2 thumbnail-list">
					<img th:each="spec : ${product.specifications}"
						th:src="@{|/images/${spec.value}|}" th:alt="${spec.name}"
						onclick="document.getElementById('mainImage').src=this.src">
				</div>
			</div>

			<!-- PRODUCT INFO -->
			<div class="col-lg-6 product-info">
				<h2 th:text="${product.name}">Product Name</h2>
				<p class="text-muted mb-2"
					th:text="'Brand: ' + ${product.brand.name}">Brand</p>
				<p class="text-muted mb-2"
					th:text="'Category: ' + ${product.subcategory.name}">Category</p>

				<!-- Rating -->
				<div class="mb-2">
					<span th:each="i : ${#numbers.sequence(1,5)}"> <i
						class="fa-star"
						th:classappend="${i <= avgRating} ? 'fas text-warning' : 'far text-muted'"></i>
					</span> <small
						th:text="'(' + ${#lists.size(product.reviews)} + ' reviews)'"></small>
				</div>

				<!-- Price -->
				<div class="mb-3">
					<span class="text-primary fw-bold price"
						th:text="${product.discount_price != null and product.discount_price.compareTo(T(java.math.BigDecimal).ZERO) > 0 ? 
                               #numbers.formatDecimal(product.discount_price,0,'POINT',0,'POINT') + ' VNĐ' : 
                               #numbers.formatDecimal(product.price,0,'POINT',0,'POINT') + ' VNĐ'}"></span>
					<del class="text-muted ms-2"
						th:if="${product.discount_price != null and product.discount_price.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
						th:text="${#numbers.formatDecimal(product.price,0,'POINT',0,'POINT') + ' VNĐ'}"></del>
				</div>
				
			    <div class="d-flex flex-column gap-2 buttons-row">
			    <!-- Quantity + Add to Cart -->
			    <form th:action="@{/cart/add}" method="post" class="d-flex gap-2 quantity-cart-row">
			        <input type="hidden" name="productID" th:value="${product.productID}">
			
			        <!-- Quantity -->
			        <div class="d-flex align-items-center border rounded overflow-hidden quantity-wrapper">
			            <button type="button" class="btn btn-outline-secondary px-3" onclick="quantityInput.stepDown()">-</button>
			            <input type="number" name="quantity"
			                   th:value="${param.quantity != null ? param.quantity : 1}" min="1"
			                   class="form-control text-center flex-grow-1" id="quantityInput">
			            <button type="button" class="btn btn-outline-secondary px-3" onclick="quantityInput.stepUp()">+</button>
			        </div>
			
			        <!-- Add to Cart -->
			        <button type="submit" class="btn btn-primary btn-modern flex-grow-1">
			            <i class="fas fa-cart-plus me-2"></i>Thêm vào giỏ
			        </button>
			    </form>
			
			    <!-- Favorite + Chat -->
			    <div class="d-flex gap-2 favorite-chat-row">
			    	<input type="hidden" id="currentUserId" th:value="${#authentication?.name}">
			        <button type="button" class="btn btn-outline-danger btn-modern flex-grow-1 favorite-btn"
			                th:data-id="${product.productID}">
			            <i class="far fa-heart me-2"></i>Yêu thích
			        </button>
			
			        <button type="button" 
					        class="btn btn-outline-primary btn-modern flex-grow-1"
					        th:if="${product.ownerUser != null}"
					        th:data-vendor-id="${product.ownerUser.userID}"
					        onclick="startChat(this)">
					    <i class="fas fa-comments me-2"></i>Chat với shop
					</button>
			    </div>
			</div>

				<!-- Short Description -->
				<div class="mt-4">
					<h5>Description</h5>
					<p th:text="${product.description}" class="text-muted"></p>
				</div>
			</div>
		</div>

		<!-- Tabs -->
		<div class="mt-5">
			<ul class="nav nav-tabs" id="productTab" role="tablist">
				<li class="nav-item">
					<button class="nav-link active" id="detail-tab"
						data-bs-toggle="tab" data-bs-target="#detail">Details</button>
				</li>
				<li class="nav-item">
					<button class="nav-link" id="specs-tab" data-bs-toggle="tab"
						data-bs-target="#specs">Specifications</button>
				</li>
				<li class="nav-item">
					<button class="nav-link" id="reviews-tab" data-bs-toggle="tab"
						data-bs-target="#reviews">Reviews</button>
				</li>
			</ul>

			<div class="tab-content p-4 border border-top-0 rounded-bottom">
				<!-- Detail -->
				<div class="tab-pane fade show active" id="detail">
					<p th:text="${product.description}" class="text-muted"></p>
				</div>

				<!-- Specifications -->
				<div class="tab-pane fade" id="specs">
					<table class="table specs-table">
						<thead>
							<tr>
								<th>Property</th>
								<th>Value</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="spec : ${product.specifications}">
								<td th:text="${spec.name}">Spec Name</td>
								<td th:text="${spec.value}">Spec Value</td>
							</tr>
						</tbody>
					</table>
				</div>

				<!-- Reviews -->
				<div class="tab-pane fade" id="reviews">
				    <div th:if="${reviewPage.totalElements == 0}" class="text-center text-muted py-3">
				        No reviews yet.
				    </div>
				
				    <!-- Danh sách review -->
				    <div th:each="review : ${reviewPage.content}" class="review-box border-bottom pb-3 mb-3">
				        <div class="d-flex justify-content-between align-items-center mb-2">
				            <strong th:text="${review.user.username}">User</strong>
				            <span>
				                <i class="fa-star"
				                   th:each="i : ${#numbers.sequence(1,5)}"
				                   th:classappend="${i <= review.rating} ? 'fas text-warning' : 'far text-muted'"></i>
				            </span>
				        </div>
				        <p th:text="${review.comment}" class="text-muted mb-0"></p>
				        <small class="text-muted"
				               th:text="${#temporals.format(review.createAt, 'dd/MM/yyyy HH:mm')}"></small>
				    </div>
				
				    <!-- Phân trang -->
				    <nav th:if="${reviewPage.totalPages > 1}" class="mt-3">
				        <ul class="pagination justify-content-center">
				            <li class="page-item" th:classappend="${reviewPage.first} ? 'disabled'">
				                <a class="page-link"
				                   th:href="@{/product/{id}(id=${product.productID}, page=${reviewPage.number - 1})}"
				                   tabindex="-1">Trước</a>
				            </li>
				
				            <li class="page-item"
				                th:each="i : ${#numbers.sequence(0, reviewPage.totalPages - 1)}"
				                th:classappend="${i == reviewPage.number} ? 'active'">
				                <a class="page-link"
				                   th:href="@{/product/{id}(id=${product.productID}, page=${i})}"
				                   th:text="${i + 1}">1</a>
				            </li>
				
				            <li class="page-item" th:classappend="${reviewPage.last} ? 'disabled'">
				                <a class="page-link"
				                   th:href="@{/product/{id}(id=${product.productID}, page=${reviewPage.number + 1})}">
				                    Sau
				                </a>
				            </li>
				        </ul>
				    </nav>
				    <!-- Form thêm đánh giá -->
					<div th:if="${#authorization.expression('isAuthenticated()')}" class="mb-4">
					    <form th:action="@{/reviews/add}" method="post" class="border p-3 rounded shadow-sm">
					        <input type="hidden" name="productID" th:value="${product.productID}">
							<div th:if="${success}" class="alert alert-success text-center mt-3" th:text="${success}"></div>
							<div th:if="${error}" class="alert alert-danger text-center mt-3" th:text="${error}"></div>
					        <div class="mb-3">
					            <label class="form-label fw-bold">Đánh giá của bạn</label>
					            <div class="rating-stars mb-2">
								    <input type="radio" name="rating" id="star5" value="5">
								    <label for="star5" title="5 sao"><i class="fas fa-star"></i></label>
								
								    <input type="radio" name="rating" id="star4" value="4">
								    <label for="star4" title="4 sao"><i class="fas fa-star"></i></label>
								
								    <input type="radio" name="rating" id="star3" value="3">
								    <label for="star3" title="3 sao"><i class="fas fa-star"></i></label>
								
								    <input type="radio" name="rating" id="star2" value="2">
								    <label for="star2" title="2 sao"><i class="fas fa-star"></i></label>
								
								    <input type="radio" name="rating" id="star1" value="1">
								    <label for="star1" title="1 sao"><i class="fas fa-star"></i></label>
								</div>
					        </div>
					
					        <div class="mb-3">
					            <label class="form-label fw-bold">Bình luận</label>
					            <textarea name="comment" class="form-control" rows="3"
					                      placeholder="Viết cảm nhận của bạn (tối thiểu 50 ký tự)..." required></textarea>
					        </div>
					
					        <button type="submit" class="btn btn-primary btn-modern">
					            <i class="fas fa-paper-plane me-2"></i>Gửi đánh giá
					        </button>
					    </form>
					</div>
				</div>
			</div>
		</div>

		<!-- Related Products -->
		<section class="mt-5">
	    	<h4>Related Products</h4>
	    	<div class="row g-3">
	        	<div class="col-lg-3 col-md-4 col-sm-6" th:each="rel : ${relatedProducts}">
	            	<div class="card h-100 text-center shadow-sm position-relative">
	                	<img th:src="${rel.thumbnail}" th:alt="${rel.name}" class="card-img-top">
	
	                <!-- BADGES -->
	                <div class="badge bg-danger position-absolute top-0 start-0 m-2"
	                     th:if="${rel.discount_price != null and rel.discount_price.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
	                     th:text="'-' + ${T(java.lang.Math).round((1 - rel.discount_price.doubleValue() / rel.price.doubleValue()) * 100)} + '%'">
	                </div>
	                <div class="card-body">
	                    <h6 th:text="${rel.name}"></h6>
	                    <p class="text-primary fw-bold"
	                       th:text="${#numbers.formatDecimal((rel.discount_price != null and rel.discount_price.compareTo(T(java.math.BigDecimal).ZERO) > 0) ? rel.discount_price : rel.price,0,'POINT',0,'POINT') + ' VNĐ'}"></p>
	                    <del class="text-muted small"
	                         th:if="${rel.discount_price != null and rel.discount_price.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
	                         th:text="${#numbers.formatDecimal(rel.price,0,'POINT',0,'POINT') + ' VNĐ'}"></del>
	                    <a th:href="@{/product/{id}(id=${rel.productID})}" class="btn btn-outline-primary w-100 btn-modern">
	                        <i class="fas fa-eye me-1"></i> Xem chi tiết
	                    </a>
	                </div>
	            </div>
	        </div>
	    </div>
	</section>

	</div>

	<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script>
    const quantityInput = document.getElementById('quantityInput');
</script>
</body>
</html>
